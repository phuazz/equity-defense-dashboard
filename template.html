<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="theme-color" content="#ffffff">
<title>S&P 500 Risk Overlay — Defensive Regime Monitor</title>
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Source+Serif+4:opsz,wght@8..60,400;8..60,600;8..60,700&family=Source+Sans+3:wght@400;500;600;700&family=IBM+Plex+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#fff;--sf:#f8f9fa;--cd:#fff;--b:#e2e5e9;--t1:#1a1a2e;--t2:#555b6e;--t3:#8e95a5;--grn:#15803d;--grn-bg:rgba(22,163,74,.06);--red:#dc2626;--red-bg:rgba(220,38,38,.05);--blu:#2563eb;--blu-bg:rgba(37,99,235,.05);--amb:#b45309;--amb-bg:rgba(180,83,9,.05);--pur:#7c3aed;--safe-b:env(safe-area-inset-bottom,0px)}
html{font-size:15px}body{font-family:'Source Sans 3',system-ui,-apple-system,sans-serif;background:var(--bg);color:var(--t1);line-height:1.6;overflow-x:hidden;-webkit-font-smoothing:antialiased;-webkit-tap-highlight-color:transparent;padding-bottom:var(--safe-b)}
.mono{font-family:'IBM Plex Mono',monospace;font-size:.86em}
#loading{position:fixed;inset:0;background:var(--bg);z-index:9999;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:14px;padding:20px}
#loading h2{font-family:'Source Serif 4',serif;font-size:20px;font-weight:600;text-align:center}
#load-bar-wrap{width:min(320px,80vw);height:3px;background:var(--b);border-radius:2px;overflow:hidden}
#load-bar{height:100%;width:0%;background:linear-gradient(90deg,var(--blu),#0891b2);transition:width .3s}
#load-status{color:var(--t2);font-size:12px}#load-log{color:var(--t3);font-size:10px;font-family:'IBM Plex Mono',monospace;max-height:80px;overflow-y:auto;width:min(400px,85vw);text-align:center;margin-top:4px}
#cache-controls{margin-top:8px}#cache-status{font-size:10px;color:var(--t3)}
.hd{background:var(--sf);border-bottom:1px solid var(--b);padding:14px 16px 12px}
.hd-inner{max-width:1400px;margin:0 auto;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px}
.hd h1{font-family:'Source Serif 4',serif;font-size:clamp(16px,3.5vw,24px);font-weight:700;letter-spacing:-.4px}
.hd h1 span{color:var(--t3);font-weight:400}
.hd-right{text-align:right;font-size:11px;color:var(--t2)}.hd-right .mono{color:var(--t1);font-size:12px}
@media(max-width:767px){.hd-right{font-size:10px}}
@media(min-width:768px){.hd{padding:20px 32px 16px}}
.tabs{background:var(--bg);border-bottom:1px solid var(--b);position:sticky;top:0;z-index:100;padding:0 8px}
.tabs-inner{max-width:1400px;margin:0 auto;display:flex;overflow-x:auto;scrollbar-width:none}.tabs-inner::-webkit-scrollbar{display:none}
.tab{background:none;border:none;color:var(--t3);font-family:'Source Sans 3',sans-serif;font-size:12px;font-weight:600;padding:10px 10px;cursor:pointer;border-bottom:2px solid transparent;white-space:nowrap;-webkit-tap-highlight-color:transparent;min-height:44px;display:flex;align-items:center}
.tab.on{color:var(--blu);border-bottom-color:var(--blu)}
@media(min-width:768px){.tabs{padding:0 32px}.tab{font-size:13px;padding:12px 16px}}
.pnl{display:none;max-width:1400px;margin:0 auto;padding:12px 12px 32px}.pnl.on{display:block}
@media(min-width:768px){.pnl{padding:20px 32px 48px}}
.g{display:grid;gap:8px}.g2{grid-template-columns:1fr}.g3{grid-template-columns:1fr 1fr}.g4{grid-template-columns:1fr 1fr}
@media(min-width:600px){.g3{grid-template-columns:repeat(3,1fr)}.g4{grid-template-columns:repeat(4,1fr)}}
@media(min-width:768px){.g2{grid-template-columns:1fr 1fr}.g{gap:14px}}
.cd{background:var(--cd);border:1px solid var(--b);border-radius:10px;padding:12px 14px}
.cd-t{font-size:10px;text-transform:uppercase;letter-spacing:.6px;color:var(--t3);font-weight:600;margin-bottom:1px}
.cd-v{font-size:22px;font-weight:700;letter-spacing:-.5px;font-family:'IBM Plex Mono',monospace;line-height:1.2}
.cd-s{font-size:11px;color:var(--t2);margin-top:1px}
@media(min-width:768px){.cd{padding:16px 20px}.cd-v{font-size:26px}}
.pos{color:var(--grn)}.neg{color:var(--red)}.wrn{color:var(--amb)}
.regime{border-radius:12px;padding:20px 16px;text-align:center;margin:8px 0 12px;border:2px solid}
.regime.r-s{background:var(--grn-bg);border-color:var(--grn)}.regime.r-w{background:var(--amb-bg);border-color:var(--amb)}.regime.r-d{background:var(--red-bg);border-color:var(--red)}
.regime-score{font-family:'IBM Plex Mono',monospace;font-size:48px;font-weight:700;line-height:1}
.regime-label{font-size:14px;font-weight:700;text-transform:uppercase;letter-spacing:1px;margin-top:4px}
.regime-action{font-size:13px;color:var(--t2);margin-top:8px;line-height:1.5}
@media(min-width:768px){.regime{padding:28px 20px}.regime-score{font-size:64px}.regime-label{font-size:16px}}
.sig-row{display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid var(--b);font-size:13px;min-height:44px}.sig-row:last-child{border:none}
.sig-name{font-weight:600;flex:1}.sig-val{text-align:right;display:flex;align-items:center;gap:6px}
.sec{font-family:'Source Serif 4',serif;font-size:16px;font-weight:600;margin:20px 0 8px;padding-bottom:5px;border-bottom:1px solid var(--b)}
@media(min-width:768px){.sec{font-size:19px;margin:26px 0 12px}}
.ch{background:var(--cd);border:1px solid var(--b);border-radius:10px;padding:8px;margin:8px 0;overflow:hidden}
.ch-t{font-size:10px;text-transform:uppercase;letter-spacing:.6px;color:var(--t3);font-weight:600;padding:0 4px 4px}
@media(min-width:768px){.ch{padding:14px;margin:14px 0}.ch-t{font-size:11px}}
.tbl{overflow-x:auto;-webkit-overflow-scrolling:touch;margin:8px 0;border:1px solid var(--b);border-radius:10px}
table{width:100%;border-collapse:collapse;font-size:11px;white-space:nowrap}
thead th{text-align:left;padding:8px 7px;background:var(--sf);border-bottom:2px solid var(--b);font-weight:700;font-size:9px;text-transform:uppercase;letter-spacing:.4px;color:var(--t2);position:sticky;top:0;z-index:5}
tbody td{padding:6px 7px;border-bottom:1px solid var(--b)}
@media(min-width:768px){table{font-size:13px}thead th{padding:10px 12px;font-size:10px}tbody td{padding:8px 12px}}
.bg{display:inline-flex;align-items:center;padding:2px 6px;border-radius:4px;font-size:10px;font-weight:600;font-family:'IBM Plex Mono',monospace;line-height:1.3}
.bg-r{background:var(--red-bg);color:var(--red)}.bg-g{background:var(--grn-bg);color:var(--grn)}.bg-w{background:var(--amb-bg);color:var(--amb)}.bg-b{background:var(--blu-bg);color:var(--blu)}
.box{background:var(--sf);border:1px solid var(--b);border-radius:10px;padding:12px;margin:8px 0;font-size:12px;color:var(--t2);line-height:1.6}.box strong{color:var(--t1)}
.sbox{border:1px solid var(--grn);border-radius:10px;padding:12px 14px;background:var(--grn-bg);margin:8px 0}
.sbox h3{color:var(--grn);font-size:13px;margin-bottom:3px;font-weight:700}.sbox p{color:var(--t2);font-size:12px;line-height:1.5}
.qc{border:2px solid var(--amb);border-radius:10px;padding:14px;background:var(--amb-bg);margin:12px 0}
.qc h3{color:var(--amb);font-size:14px;margin-bottom:8px;font-family:'Source Serif 4',serif;font-weight:700}
.qi{display:flex;justify-content:space-between;padding:5px 0;border-bottom:1px solid rgba(180,83,9,.08);font-size:12px;gap:6px}.qi:last-child{border:none}
.qi span:first-child{flex:1;min-width:0}.qi span:last-child{text-align:right;flex-shrink:0}
.sa{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin:8px 0}
@media(min-width:600px){.sa{grid-template-columns:repeat(4,1fr)}}
.sa-c{background:var(--cd);border:1px solid var(--b);border-radius:10px;padding:10px;text-align:center}
.sa-l{font-size:9px;text-transform:uppercase;letter-spacing:.3px;color:var(--t3);font-weight:600}
.sa-v{font-size:20px;font-weight:700;font-family:'IBM Plex Mono',monospace;margin:2px 0;line-height:1.2}
.sa-s{font-size:10px;color:var(--t2)}
@media(min-width:768px){.sa-l{font-size:10px}.sa-v{font-size:24px}}
.cmp th{background:var(--blu-bg);color:var(--blu)}
.alloc-bar{display:flex;height:36px;border-radius:8px;overflow:hidden;margin:6px 0;border:1px solid var(--b)}
.alloc-bar div{display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;font-family:'IBM Plex Mono',monospace}
.alloc-spy{background:#2563eb;color:#fff}.alloc-ief{background:#15803d;color:#fff}.alloc-label{margin-top:4px;font-size:11px;color:var(--t3);display:flex;justify-content:space-between}
.prox-bar-wrap{height:4px;background:var(--b);border-radius:2px;margin-top:4px;position:relative;overflow:visible}
.prox-bar{height:100%;border-radius:2px;transition:width .3s}
.prox-marker{position:absolute;top:-3px;width:2px;height:10px;background:var(--t1);border-radius:1px}
::-webkit-scrollbar{width:5px;height:3px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--b);border-radius:3px}
</style>
</head>
<body>
<div id="loading"><h2>S&P 500 Risk Overlay</h2><div id="load-bar-wrap"><div id="load-bar"></div></div><div id="load-status">Initializing…</div><div id="load-log"></div><div id="cache-controls"><span id="cache-status"></span></div></div>
<div class="hd"><div class="hd-inner"><div><h1>S&P 500 Risk Overlay <span>/ Regime Monitor</span></h1></div><div class="hd-right"><div class="mono" id="hd-period">—</div><div id="hd-updated">—</div></div></div></div>
<div class="tabs"><div class="tabs-inner">
<button class="tab on" data-t="t-mon">Monitor</button><button class="tab" data-t="t-ov">Overview</button><button class="tab" data-t="t-cmp">Compare</button><button class="tab" data-t="t-sig">Signals</button><button class="tab" data-t="t-str">Strategies</button><button class="tab" data-t="t-ev">Events</button><button class="tab" data-t="t-rsk">Risk</button><button class="tab" data-t="t-qc">QC</button>
</div></div>
<div class="pnl on" id="t-mon">
<div id="regime-hero"></div>
<div class="g g3" id="mon-cards"></div>
<div class="sec" style="font-size:14px">Current Allocation</div>
<div id="mon-alloc"></div>
<div class="sec" style="font-size:14px">5 Risk Signals — Proximity to Trigger</div>
<div class="cd" id="mon-sig"></div>
<div class="sec" style="font-size:14px">Regime Context</div>
<div class="cd" id="mon-context"></div>
<div class="ch"><div class="ch-t">Score Distribution (% of all days)</div><div id="ch-sdist" style="height:140px"></div></div>
<div class="ch"><div class="ch-t">Allocation History (2Y)</div><div id="ch-ahist" style="height:140px"></div></div>
<div class="ch"><div class="ch-t">Composite Score History</div><div id="ch-score" style="height:180px"></div></div>
</div>
<div class="pnl" id="t-ov"><div class="g g4" id="ov-cards"></div><div class="ch"><div class="ch-t">S&P 500 Total Return + Stress Events</div><div id="ch-eq" style="height:280px"></div></div><div class="g g2"><div class="ch"><div class="ch-t">Drawdown — All Strategies</div><div id="ch-dd" style="height:220px"></div></div><div class="ch"><div class="ch-t">8-Day Stress Count</div><div id="ch-bu" style="height:220px"></div></div></div><div class="ch"><div class="ch-t">Equity Curves (Log)</div><div id="ch-st" style="height:300px"></div></div></div>
<div class="pnl" id="t-cmp"><div class="sec">Strategy Comparison</div><div class="tbl" id="cmp-tbl"></div><div class="ch"><div class="ch-t">Annual Returns</div><div id="ch-ann" style="height:280px"></div></div><div class="g g2"><div class="ch"><div class="ch-t">DD: Composite vs B&H</div><div id="ch-ddc" style="height:220px"></div></div><div class="ch"><div class="ch-t">Defensive Allocation %</div><div id="ch-alloc" style="height:220px"></div></div></div></div>
<div class="pnl" id="t-sig"><div class="sec">Forward Returns After Stress Events</div><div class="box">What happens after a stress signal fires? <strong id="sig-n">—</strong> historical events analyzed across 1–12 month horizons.</div><div id="sig-cards" class="sa"></div><div class="sec" style="font-size:14px">Per-Event Returns</div><div class="tbl" id="sig-tbl"></div><div class="ch"><div class="ch-t">Forward Paths (12M)</div><div id="ch-fwd" style="height:260px"></div></div><div class="box" id="sig-interp"></div><div class="g g2"><div class="ch"><div class="ch-t">Max DD Distribution</div><div id="ch-fdd" style="height:220px"></div></div><div class="ch"><div class="ch-t">Distance from ATH at Signal</div><div id="ch-ath" style="height:220px"></div></div></div><div class="sec" style="font-size:14px">Statistics</div><div class="cd" id="sig-stats"></div></div>
<div class="pnl" id="t-str"><div class="sec">5 Defensive Strategies</div><div class="sbox"><h3>S1: Enhanced Stress Signal</h3><p><strong>Entry:</strong> 8D count ≥115 OR (SPX &lt; 200d AND canary bad) → IEF. <strong>Exit:</strong> SPX &gt; 200d + canary clear + 63d cooldown.</p></div><div class="sbox"><h3>S2: Faber 10-Month SMA</h3><p>Monthly. SPX &gt; 10M SMA → SPY, else → IEF. Source: Faber (2007).</p></div><div class="sbox"><h3>S3: Dual Momentum (Antonacci)</h3><p>Monthly. SPY 12M &gt; IEF 12M AND &gt; 0 → SPY, else → IEF.</p></div><div class="sbox"><h3>S4: Composite (≥2 of 5)</h3><p>Score 5 sub-signals. ≥2 → 100% IEF. =1 → 50/50.</p></div><div class="sbox"><h3>S5: Buy &amp; Hold</h3><p>100% SPY. Benchmark.</p></div></div>
<div class="pnl" id="t-ev"><div class="sec">Stress Event Log</div><div class="tbl" style="max-height:75vh;overflow-y:auto"><table><thead><tr><th>#</th><th>Date</th><th>8D</th><th>SPX</th><th>ATH</th><th>Can</th><th>MA</th><th>1M</th><th>3M</th><th>6M</th><th>12M</th><th>DD</th></tr></thead><tbody id="ev-body"></tbody></table></div></div>
<div class="pnl" id="t-rsk"><div class="sec">Risk-Adjusted Metrics</div><div class="g g4" id="rsk-cards"></div><div class="g g2"><div class="ch"><div class="ch-t">Monthly Returns — Composite</div><div id="ch-mdist" style="height:220px"></div></div><div class="ch"><div class="ch-t">Rolling 12M Sharpe</div><div id="ch-rshp" style="height:220px"></div></div></div></div>
<div class="pnl" id="t-qc"><div class="sec">Quality Control</div><div class="qc"><h3>Validation</h3><div id="qc-chk"></div></div><div class="sec" style="font-size:14px">Data</div><div class="cd" id="qc-data"></div><div class="sec" style="font-size:14px">Backtest</div><div class="cd" id="qc-bt"></div><div class="sec" style="font-size:14px">Statistics</div><div class="cd" id="qc-st"></div></div>

<script>
/* __INJECT_DATA__ */
const $=s=>document.querySelector(s),$$=s=>document.querySelectorAll(s);
function setBar(p){$('#load-bar').style.width=p+'%'}
function setStatus(s){$('#load-status').textContent=s}
function log(s){const d=$('#load-log');d.innerHTML+=s+'<br>';d.scrollTop=d.scrollHeight}
function pct(v,d=1){return v==null?'—':(v>=0?'+':'')+((v*100).toFixed(d))+'%'}
function fmt(v,d=0){return v==null?'—':v.toLocaleString('en-US',{minimumFractionDigits:d,maximumFractionDigits:d})}
const M=window.innerWidth<768;
const PL=(t='')=>({paper_bgcolor:'transparent',plot_bgcolor:'transparent',font:{family:'Source Sans 3',size:M?9:12,color:'#555b6e'},title:t?{text:t,font:{size:M?10:14,color:'#1a1a2e'},x:0,xanchor:'left',y:.98}:undefined,margin:{t:t?28:8,r:M?4:16,b:M?28:36,l:M?34:56},xaxis:{gridcolor:'#eee',linecolor:'#eee',tickfont:{size:M?8:11}},yaxis:{gridcolor:'#eee',linecolor:'#eee',tickfont:{size:M?8:11}},legend:{bgcolor:'transparent',font:{size:M?8:11},orientation:'h',y:-.22,x:.5,xanchor:'center'},hovermode:M?'closest':'x unified',dragmode:false});
const PC=M?{responsive:true,displayModeBar:false,scrollZoom:false,staticPlot:true}:{responsive:true,displayModeBar:false,scrollZoom:false};
const lw=M?1:1.5;

function render(D){
const{rolling:R,signals:SIG,bt:BT,m:MET,qc:QC,allData:AD,monitor:MOND}=D;
const last=R[R.length-1];
const STR=[{k:'enh',n:'Enhanced',c:'#dc2626'},{k:'fab',n:'Faber',c:'#7c3aed',d:'dot'},{k:'dm',n:'DualMom',c:'#b45309',d:'dashdot'},{k:'comp',n:'Composite',c:'#15803d'},{k:'bh',n:'B&H',c:'#8e95a5'}];
$('#hd-period').textContent=R[0].date+' → '+last.date;
$('#hd-updated').textContent=SIG.length+' stress events · Score '+last.compositeScore+'/5';

// MONITOR
var MON=MOND||{};
var ba=last.rolling8d>=115,b2=last.sma200!=null&&last.spx<last.sma200,cb=last.canaryBad>=1,sn=last.spy12mNeg,b10=last.belowSMA10m;
var cs=last.compositeScore,rc=cs>=3?'r-d':cs>=1?'r-w':'r-s';
var rl=cs>=3?'HIGH RISK':cs>=2?'ELEVATED':cs===1?'CAUTION':'ALL CLEAR';
var ra=cs>=2?'Full Defensive — 100% IEF':cs===1?'Partial — 50% IEF / 50% SPY':'Fully Invested — 100% SPY';
var scol=cs>=3?'var(--red)':cs>=1?'var(--amb)':'var(--grn)';
$('#regime-hero').innerHTML='<div class="regime '+rc+'"><div class="regime-score" style="color:'+scol+'">'+cs+'<span style="font-size:24px;font-weight:400;color:var(--t3)">/5</span></div><div class="regime-label" style="color:'+scol+'">'+rl+'</div><div class="regime-action"><strong>'+last.date+'</strong> — '+ra+'</div></div>';
$('#mon-cards').innerHTML=[{t:'S&P 500',v:fmt(last.spx,0),s:(last.aboveSMA200?'Above':'Below')+' 200d MA'},{t:'8-Day Stress',v:last.rolling8d,c:ba?'neg':'pos',s:'Threshold: 115'},{t:'12M Return',v:pct(last.spy12mRet),c:last.spy12mRet>=0?'pos':'neg',s:'SPY total return'}].map(function(c){return '<div class="cd"><div class="cd-t">'+c.t+'</div><div class="cd-v '+(c.c||'')+'">'+c.v+'</div><div class="cd-s">'+c.s+'</div></div>'}).join('');

// Allocation bar
var spyPct=cs===0?100:cs===1?50:0,iefPct=100-spyPct;
$('#mon-alloc').innerHTML='<div class="alloc-bar">'+(spyPct>0?'<div class="alloc-spy" style="width:'+spyPct+'%">SPY '+spyPct+'%</div>':'')+(iefPct>0?'<div class="alloc-ief" style="width:'+iefPct+'%">IEF '+iefPct+'%</div>':'')+'</div><div class="alloc-label"><span>Equities</span><span>Defensive</span></div>';

// Proximity signals - show how far each is from flipping
var px=MON.proximity||{};
function proxBar(val,thresh,isBelow){var dist=thresh?Math.abs((val-thresh)/thresh):0;var pctW=Math.min(dist*100/15,100);var near=dist<0.03;var col=near?'var(--amb)':'var(--grn)';if(isBelow)col='var(--red)';return '<div class="prox-bar-wrap"><div class="prox-bar" style="width:'+pctW+'%;background:'+col+'"></div></div>'}
var si=function(v){return v?'<span class="bg bg-r">RISK</span>':'<span class="bg bg-g">OK</span>'};
var sigs=[];
// Stress
var stDist=last.rolling8d+'/115';
sigs.push({n:'Stress Count',v:si(ba),d:stDist,prox:ba?'<span class="neg" style="font-size:11px">ABOVE threshold</span>':'<span style="font-size:11px;color:var(--t3)">'+(115-last.rolling8d)+' below threshold</span>'});
// 200d MA
var ma2d=px.sma200||{};
var ma2pct=ma2d.pct!=null?ma2d.pct:0;
sigs.push({n:'200d MA',v:si(b2),d:fmt(last.spx,0)+' vs '+fmt(ma2d.ma,0),prox:'<span style="font-size:11px;color:'+(Math.abs(ma2pct)<0.03?'var(--amb)':'var(--t3)')+'">'+pct(ma2pct,1)+(Math.abs(ma2pct)<0.03?' ⚠ close':'')+'</span>'});
// Canary
sigs.push({n:'Canary (VWO/BND)',v:si(cb),d:last.canaryBad+'/'+last.canaryTotal+' negative',prox:cb?'<span class="neg" style="font-size:11px">Cross-asset stress</span>':'<span style="font-size:11px;color:var(--t3)">Both positive</span>'});
// 12M
var m12=last.spy12mRet;
sigs.push({n:'12M Momentum',v:si(sn),d:pct(m12),prox:'<span style="font-size:11px;color:'+(m12!=null&&m12<0.03&&m12>0?'var(--amb)':'var(--t3)')+'">'+( m12!=null&&m12>0&&m12<0.03?'⚠ near zero':'')+(m12!=null&&m12<0?'Negative — risk off':'')+(m12!=null&&m12>=0.03?'Healthy':'')+(m12==null?'—':'')+'</span>'});
// 10M SMA
var ma10=px.sma10m||{};
var ma10pct=ma10.pct!=null?ma10.pct:0;
sigs.push({n:'10M SMA',v:si(b10),d:fmt(last.spx,0)+' vs '+fmt(ma10.ma,0),prox:'<span style="font-size:11px;color:'+(Math.abs(ma10pct)<0.03?'var(--amb)':'var(--t3)')+'">'+pct(ma10pct,1)+(Math.abs(ma10pct)<0.03?' ⚠ close':'')+'</span>'});
$('#mon-sig').innerHTML=sigs.map(function(s){return '<div class="sig-row" style="flex-wrap:wrap"><div style="display:flex;justify-content:space-between;width:100%;align-items:center"><span class="sig-name">'+s.n+'</span><span class="sig-val">'+s.v+' <span class="mono" style="color:var(--t3);font-size:11px">'+s.d+'</span></span></div><div style="width:100%;padding-top:2px">'+s.prox+'</div></div>'}).join('');

// Regime context
var rd=MON.regimeDays||0;
var ad=MON.avgDuration||[0,0,0,0,0,0];
var sd=MON.scoreDist||[0,0,0,0,0,0];
$('#mon-context').innerHTML='<div class="qi"><span>Current regime</span><span class="mono"><strong>Score '+cs+'</strong> for <strong>'+rd+'</strong> days</span></div><div class="qi"><span>Avg duration at score '+cs+'</span><span class="mono">'+ad[cs]+' days</span></div><div class="qi"><span>% of history at score 0 (all clear)</span><span class="mono">'+(sd[0]*100).toFixed(1)+'%</span></div><div class="qi"><span>% of history at score ≥2 (defensive)</span><span class="mono">'+((sd[2]+sd[3]+sd[4]+sd[5])*100).toFixed(1)+'%</span></div>';

// Score distribution chart
var sdLabels=['0\nClear','1\nWatch','2\nElev','3\nHigh','4','5\nMax'];
var sdColors=['#15803d','#b45309','#b45309','#dc2626','#dc2626','#dc2626'];
Plotly.newPlot('ch-sdist',[{x:sdLabels,y:sd.map(function(v){return v*100}),type:'bar',marker:{color:sdColors},text:sd.map(function(v){return (v*100).toFixed(1)+'%'}),textposition:'outside',textfont:{size:M?9:11}}],Object.assign({},PL(),{yaxis:Object.assign({},PL().yaxis,{title:'% of days'}),margin:Object.assign({},PL().margin,{b:M?40:50})}),PC);

// Allocation history (2Y sparkline)
var ah=MON.allocHist||[];
if(ah.length>0){Plotly.newPlot('ch-ahist',[{x:ah.map(function(a){return a.d}),y:ah.map(function(a){return a.spy}),type:'scatter',fill:'tozeroy',name:'SPY%',line:{color:'#2563eb',width:0},fillcolor:'rgba(37,99,235,.25)'},{x:ah.map(function(a){return a.d}),y:ah.map(function(a){return a.ief}),type:'scatter',name:'IEF%',line:{color:'#15803d',width:1},fillcolor:'rgba(22,163,74,.1)'}],Object.assign({},PL(),{yaxis:Object.assign({},PL().yaxis,{range:[0,105]})}),PC)}

Plotly.newPlot('ch-score',[{x:R.map(function(r){return r.date}),y:R.map(function(r){return r.compositeScore}),type:'scatter',fill:'tozeroy',line:{color:'#dc2626',width:1},fillcolor:'rgba(220,38,38,.08)',name:'Score'},{x:[R[0].date,last.date],y:[2,2],type:'scatter',mode:'lines',name:'≥2 Def',line:{color:'#b45309',dash:'dash',width:1}}],Object.assign({},PL(),{yaxis:Object.assign({},PL().yaxis,{range:[0,5.3]})}),PC);

// OVERVIEW
$('#ov-cards').innerHTML=[{t:'B&H CAGR',v:pct(MET.bh.cagr),c:'pos'},{t:'Comp CAGR',v:pct(MET.comp.cagr),c:MET.comp.cagr>0?'pos':'neg'},{t:'B&H Max DD',v:pct(MET.bh.maxDD),c:'neg'},{t:'Comp Max DD',v:pct(MET.comp.maxDD),c:'neg'}].map(function(c){return '<div class="cd"><div class="cd-t">'+c.t+'</div><div class="cd-v '+c.c+'">'+c.v+'</div></div>'}).join('');
Plotly.newPlot('ch-eq',[{x:R.map(function(r){return r.date}),y:R.map(function(r){return r.spx}),type:'scatter',mode:'lines',name:'SPY',line:{color:'#2563eb',width:lw}},{x:SIG.map(function(s){return s.date}),y:SIG.map(function(s){return s.spx}),type:'scatter',mode:'markers',name:'Stress',marker:{color:'#dc2626',size:M?5:8,line:{color:'#fff',width:M?.5:1}}}],Object.assign({},PL(),{yaxis:Object.assign({},PL().yaxis,{type:'log'})}),PC);
Plotly.newPlot('ch-dd',STR.map(function(s){return{x:BT[s.k].map(function(e){return e.date}),y:BT[s.k].map(function(e){return e.dd*100}),type:'scatter',name:s.n,line:{color:s.c,width:s.k==='comp'?lw+.5:lw*.8,dash:s.d},fill:s.k==='comp'?'tozeroy':undefined,fillcolor:s.k==='comp'?'rgba(22,163,74,.05)':undefined}}),PL(),PC);
Plotly.newPlot('ch-bu',[{x:R.map(function(r){return r.date}),y:R.map(function(r){return r.rolling8d}),type:'scatter',mode:'lines',name:'Count',line:{color:'#b45309',width:lw}},{x:[R[0].date,last.date],y:[115,115],type:'scatter',mode:'lines',name:'115',line:{color:'#dc2626',width:1.5,dash:'dash'}}],PL(),PC);
Plotly.newPlot('ch-st',STR.map(function(s){return{x:BT[s.k].map(function(e){return e.date}),y:BT[s.k].map(function(e){return e.equity}),type:'scatter',mode:'lines',name:s.n,line:{color:s.c,width:s.k==='comp'?lw+1:lw,dash:s.d}}}),Object.assign({},PL(),{yaxis:Object.assign({},PL().yaxis,{type:'log'})}),PC);

// COMPARE
var sk=['bh','enh','fab','dm','comp'],sn2=['B&H','Enh','Faber','DM','Comp'];
var ml=['cagr','totalRet','maxDD','vol','sharpe','sortino','calmar','winRate','defFrac'],mn=['CAGR','Total','MaxDD','Vol','Sharpe','Sortino','Calmar','Win%','Def%'];
$('#cmp-tbl').innerHTML='<table class="cmp"><thead><tr><th></th>'+sn2.map(function(n){return '<th>'+n+'</th>'}).join('')+'</tr></thead><tbody>'+mn.map(function(l,i){return '<tr><td><strong>'+l+'</strong></td>'+sk.map(function(k){var x=MET[k][ml[i]];return '<td class="mono">'+(i<=3||i>=7?pct(x):x.toFixed(2))+'</td>'}).join('')+'</tr>'}).join('')+'</tbody></table>';
Plotly.newPlot('ch-ann',STR.map(function(s){return{x:MET[s.k].annual.map(function(a){return a.year}),y:MET[s.k].annual.map(function(a){return a.ret*100}),type:'bar',name:s.n,marker:{color:s.c,opacity:.6}}}),Object.assign({},PL(),{barmode:'group'}),PC);
Plotly.newPlot('ch-ddc',[{x:BT.bh.map(function(e){return e.date}),y:BT.bh.map(function(e){return e.dd*100}),type:'scatter',fill:'tozeroy',name:'B&H',line:{color:'#8e95a5',width:lw},fillcolor:'rgba(142,149,165,.05)'},{x:BT.comp.map(function(e){return e.date}),y:BT.comp.map(function(e){return e.dd*100}),type:'scatter',fill:'tozeroy',name:'Comp',line:{color:'#15803d',width:lw},fillcolor:'rgba(22,163,74,.05)'}],PL(),PC);
Plotly.newPlot('ch-alloc',[{x:BT.comp.map(function(e){return e.date}),y:BT.comp.map(function(e){return e.mode==='defensive'?100:e.mode==='partial'?50:0}),type:'scatter',fill:'tozeroy',name:'Def%',line:{color:'#b45309',width:0},fillcolor:'rgba(180,83,9,.15)'}],Object.assign({},PL(),{yaxis:Object.assign({},PL().yaxis,{range:[0,110]})}),PC);

// SIGNALS
var vs=SIG.filter(function(s){return s.fwd&&s.fwd.maxDD12M!=null});
$('#sig-n').textContent=vs.length;
if(vs.length>0){
var avg=function(k){var f=vs.filter(function(s){return s.fwd[k]!=null});return f.length?f.reduce(function(a,s){return a+s.fwd[k]},0)/f.length:null};
var med=function(k){var f=vs.filter(function(s){return s.fwd[k]!=null}).map(function(s){return s.fwd[k]}).sort(function(a,b){return a-b});return f.length?f[Math.floor(f.length/2)]:null};
var wr=function(k){var f=vs.filter(function(s){return s.fwd[k]!=null});return f.length?f.filter(function(s){return s.fwd[k]>0}).length/f.length:null};
var aDD=vs.reduce(function(a,s){return a+s.fwd.maxDD12M},0)/vs.length;
$('#sig-cards').innerHTML=[{l:'Avg 12M',v:pct(avg('fwd12M')),c:avg('fwd12M')>0?'pos':'neg',s:'Med: '+pct(med('fwd12M'))},{l:'12M Win Rate',v:pct(wr('fwd12M')),c:wr('fwd12M')>.5?'pos':'neg',s:vs.filter(function(s){return s.fwd.fwd12M!=null&&s.fwd.fwd12M>0}).length+'/'+vs.filter(function(s){return s.fwd.fwd12M!=null}).length},{l:'Avg Max DD',v:pct(aDD),c:'neg',s:'12M post-signal'},{l:'Avg 1M Fwd',v:pct(avg('fwd1M')),c:avg('fwd1M')>0?'pos':'neg',s:'Win: '+pct(wr('fwd1M'))}].map(function(c){return '<div class="sa-c"><div class="sa-l">'+c.l+'</div><div class="sa-v '+c.c+'">'+c.v+'</div><div class="sa-s">'+c.s+'</div></div>'}).join('');
var tr=vs.map(function(s){var c=function(v){return v==null?'':v>0?'pos':'neg'};return '<tr><td class="mono">'+s.date+'</td><td><span class="bg bg-r">'+s.rolling8d+'</span></td><td class="'+c(s.fwd.fwd1M)+'">'+pct(s.fwd.fwd1M)+'</td><td class="'+c(s.fwd.fwd3M)+'">'+pct(s.fwd.fwd3M)+'</td><td class="'+c(s.fwd.fwd6M)+'">'+pct(s.fwd.fwd6M)+'</td><td class="'+c(s.fwd.fwd12M)+'">'+pct(s.fwd.fwd12M)+'</td><td class="neg">'+pct(s.fwd.maxDD12M)+'</td></tr>'}).join('');
tr+='<tr style="font-weight:700;border-top:2px solid var(--b)"><td>AVG</td><td></td><td class="'+(avg('fwd1M')>0?'pos':'neg')+'">'+pct(avg('fwd1M'))+'</td><td class="'+(avg('fwd3M')>0?'pos':'neg')+'">'+pct(avg('fwd3M'))+'</td><td class="'+(avg('fwd6M')>0?'pos':'neg')+'">'+pct(avg('fwd6M'))+'</td><td class="'+(avg('fwd12M')>0?'pos':'neg')+'">'+pct(avg('fwd12M'))+'</td><td class="neg">'+pct(aDD)+'</td></tr>';
tr+='<tr style="font-weight:700"><td>MED</td><td></td><td>'+pct(med('fwd1M'))+'</td><td>'+pct(med('fwd3M'))+'</td><td>'+pct(med('fwd6M'))+'</td><td>'+pct(med('fwd12M'))+'</td><td></td></tr>';
$('#sig-tbl').innerHTML='<table><thead><tr><th>Date</th><th>8D</th><th>1M</th><th>3M</th><th>6M</th><th>12M</th><th>DD</th></tr></thead><tbody>'+tr+'</tbody></table>';
var p12=vs.filter(function(s){return s.fwd.fwd12M!=null&&s.fwd.fwd12M>0}).length,t12=vs.filter(function(s){return s.fwd.fwd12M!=null}).length;
$('#sig-interp').innerHTML='<strong>Summary:</strong> '+p12+'/'+t12+' events ('+(p12/t12*100).toFixed(0)+'%) saw positive 12M returns. Average: '+pct(avg('fwd12M'))+'. Max drawdown: '+pct(aDD)+'. '+(avg('fwd3M')<0?'Short-term pain persists ~3M.':'Recovery begins early.')+' Mean-median spread: '+(Math.abs(avg('fwd12M')-med('fwd12M'))>.05?'wide — outlier-driven.':'tight — consistent.');
Plotly.newPlot('ch-fwd',vs.map(function(s){return{x:Array.from({length:s.fwd.path.length},function(_,j){return j}),y:s.fwd.path.map(function(v){return v*100}),type:'scatter',mode:'lines',name:s.date,line:{width:M?.7:1.2},opacity:.6}}),Object.assign({},PL(),{showlegend:!M}),PC);
Plotly.newPlot('ch-fdd',[{x:vs.map(function(s){return s.fwd.maxDD12M*100}),type:'histogram',nbinsx:10,marker:{color:'rgba(220,38,38,.5)',line:{color:'#dc2626',width:1}}}],PL(),PC);
Plotly.newPlot('ch-ath',[{x:SIG.map(function(s){return s.date}),y:SIG.map(function(s){return s.athDist*100}),type:'bar',marker:{color:SIG.map(function(s){return s.athDist>-.05?'#dc2626':'#2563eb'})}}],PL(),PC);
var dv=vs.map(function(s){return s.fwd.maxDD12M}),dm=dv.reduce(function(a,b){return a+b},0)/dv.length,ds=Math.sqrt(dv.reduce(function(a,v){return a+(v-dm)*(v-dm)},0)/(dv.length-1)),de=ds/Math.sqrt(dv.length);
$('#sig-stats').innerHTML=[['N',vs.length],['Mean DD',(dm*100).toFixed(1)+'%'],['SE','±'+(de*100).toFixed(1)+'%'],['95% CI','['+((dm-1.96*de)*100).toFixed(1)+'%, '+((dm+1.96*de)*100).toFixed(1)+'%]'],['12M Win',pct(wr('fwd12M'))],['Median 12M',pct(med('fwd12M'))]].map(function(p){return '<div class="qi"><span>'+p[0]+'</span><span class="mono">'+p[1]+'</span></div>'}).join('');
}

// EVENTS
$('#ev-body').innerHTML=SIG.map(function(s,i){var c=function(v){return v==null?'':v>0?'pos':'neg'};return '<tr><td>'+(i+1)+'</td><td class="mono">'+s.date+'</td><td><span class="bg bg-r">'+s.rolling8d+'</span></td><td class="mono">'+fmt(s.spx,0)+'</td><td><span class="bg '+(s.athDist>-.05?'bg-r':'bg-b')+'">'+pct(s.athDist,0)+'</span></td><td>'+(s.canaryBad>0?'<span class="bg bg-w">!</span>':'<span class="bg bg-g">✓</span>')+'</td><td>'+(s.aboveSMA200?'<span class="bg bg-g">↑</span>':'<span class="bg bg-r">↓</span>')+'</td><td class="'+c(s.fwd.fwd1M)+'">'+pct(s.fwd.fwd1M)+'</td><td class="'+c(s.fwd.fwd3M)+'">'+pct(s.fwd.fwd3M)+'</td><td class="'+c(s.fwd.fwd6M)+'">'+pct(s.fwd.fwd6M)+'</td><td class="'+c(s.fwd.fwd12M)+'">'+pct(s.fwd.fwd12M)+'</td><td class="neg">'+pct(s.fwd.maxDD12M)+'</td></tr>'}).join('');

// RISK
$('#rsk-cards').innerHTML=STR.map(function(s){return{t:s.n+' Sharpe',v:MET[s.k].sharpe.toFixed(2)}}).concat([{t:'Comp Sortino',v:MET.comp.sortino.toFixed(2)},{t:'Comp Calmar',v:MET.comp.calmar.toFixed(2)},{t:'Comp Vol',v:pct(MET.comp.vol)}]).slice(0,8).map(function(c){return '<div class="cd"><div class="cd-t">'+c.t+'</div><div class="cd-v">'+c.v+'</div></div>'}).join('');
Plotly.newPlot('ch-mdist',[{x:MET.comp.monthly.map(function(r){return r.ret*100}),type:'histogram',nbinsx:30,marker:{color:'rgba(22,163,74,.35)',line:{color:'#15803d',width:1}}}],PL(),PC);
var rr=['comp','bh','enh'].map(function(k){var s=STR.find(function(x){return x.k===k});var rs=[];for(var i=252;i<BT[k].length;i++){var w=[];for(var j=i-251;j<=i;j++)w.push(BT[k][j].equity/BT[k][j-1].equity-1);var wm=w.reduce(function(a,b){return a+b},0)/w.length;var wv=Math.sqrt(w.reduce(function(a,r){return a+(r-wm)*(r-wm)},0)/(w.length-1))*Math.sqrt(252);rs.push({d:BT[k][i].date,sh:wv>0?((BT[k][i].equity/BT[k][i-252].equity-1)-.02)/wv:0})}return{x:rs.map(function(r){return r.d}),y:rs.map(function(r){return r.sh}),type:'scatter',mode:'lines',name:s.n,line:{color:s.c,width:lw,dash:s.d}}});
Plotly.newPlot('ch-rshp',rr,PL(),PC);

// QC
$('#qc-chk').innerHTML=QC.map(function(c){return '<div class="qi"><span><strong>['+c.cat+']</strong> '+c.chk+'</span><span style="color:'+(c.st==='pass'?'var(--grn)':c.st==='warn'?'var(--amb)':'var(--red)')+'">'+(c.st==='pass'?'✓':'⚠')+' '+c.res+'</span></div>'}).join('');
$('#qc-data').innerHTML=[['Stocks',(AD.meta?AD.meta.stockCount:90)+'/90'],['Data','Adj Close (total return)'],['Pipeline','GitHub Actions (daily)']].map(function(p){return '<div class="qi"><span>'+p[0]+'</span><span>'+p[1]+'</span></div>'}).join('');
$('#qc-bt').innerHTML=[['Execution','Stress T+1, Regime T+0'],['Defensive','IEF (7-10Y UST)'],['Tx Costs','5bps per allocation change'],['Strategies','5 (Enh, Faber, DM, Comp, B&H)']].map(function(p){return '<div class="qi"><span>'+p[0]+'</span><span>'+p[1]+'</span></div>'}).join('');
var vs2=SIG.filter(function(s){return s.fwd&&s.fwd.maxDD12M!=null});
if(vs2.length>0){var dv2=vs2.map(function(s){return s.fwd.maxDD12M}),dm2=dv2.reduce(function(a,b){return a+b},0)/dv2.length,ds2=Math.sqrt(dv2.reduce(function(a,v){return a+(v-dm2)*(v-dm2)},0)/(dv2.length-1)),de2=ds2/Math.sqrt(dv2.length);$('#qc-st').innerHTML=[['N',SIG.length],['Avg fwd DD',(dm2*100).toFixed(1)+'% ±'+(de2*100).toFixed(1)+'%'],['95% CI','['+((dm2-1.96*de2)*100).toFixed(1)+'%, '+((dm2+1.96*de2)*100).toFixed(1)+'%]']].map(function(p){return '<div class="qi"><span>'+p[0]+'</span><span class="mono">'+p[1]+'</span></div>'}).join('')}
}

// TABS
$$('.tab').forEach(function(b){
  b.addEventListener('click',function(){
    $$('.tab').forEach(function(x){x.classList.remove('on')});
    $$('.pnl').forEach(function(x){x.classList.remove('on')});
    b.classList.add('on');
    document.getElementById(b.dataset.t).classList.add('on');
    setTimeout(function(){window.dispatchEvent(new Event('resize'))},80);
  });
});

// MAIN
function main(){
  try{
    setBar(10);setStatus('Loading…');
    if(typeof PRECOMPUTED_DATA==='undefined') throw new Error('No data — run pipeline.py');
    var d=PRECOMPUTED_DATA;
    setBar(60);setStatus('Rendering…');
    render({rolling:d.rolling,signals:d.signals,bt:d.bt,m:d.metrics,qc:d.qc,allData:{meta:d.meta},monitor:d.monitor||{}});
    setBar(100);log('✅ Ready');
    try{$('#cache-status').textContent='Updated: '+d.meta.endDate}catch(e){}
    setTimeout(function(){$('#loading').style.opacity='0';$('#loading').style.transition='opacity .35s';setTimeout(function(){$('#loading').style.display='none'},350)},200);
  }catch(e){setStatus(e.message);log('❌ '+e.stack);$('#load-bar').style.background='#dc2626'}
}
(function w(){typeof Plotly==='undefined'?setTimeout(w,100):main()})();
</script>
</body>
</html>
